# S7 PLC数据采集系统 - 调试信息说明文档

本文档列出了S7 PLC数据采集系统中所有可能出现的调试信息，帮助开发人员快速定位问题。

## 日志级别说明

- **Information**: 重要操作和状态变化
- **Warning**: 警告信息，不影响主要功能
- **Error**: 错误信息，需要关注
- **Debug**: 详细的调试信息，用于问题排查
- **Trace**: 最详细的跟踪信息，包括每个数据读取操作

## 一、服务启动相关调试信息

### 1.1 服务启动
```
[服务启动] S7 PLC数据采集服务启动
[服务启动] 服务配置 - CollectInterval: 5秒, Rack: 0, Slot: 1, DataBlock: 1
[服务启动] 等待应用程序完全启动 (5秒)...
[服务启动] 开始加载并连接所有设备...
[服务启动] 设备连接完成 - 已连接设备数: X, 总设备数: Y
[服务启动] 启动设备状态监控任务...
[服务启动] 开始定时采集数据循环...
```

### 1.2 服务停止
```
[服务停止] 正在停止S7 PLC数据采集服务...
[服务停止] 等待监控任务结束...
[服务停止] S7 PLC数据采集服务已停止
```

### 1.3 服务异常
```
[服务异常] S7 PLC数据采集服务执行出错
[服务异常] 异常详情 - 类型: ExceptionType, 消息: ExceptionMessage, 堆栈: StackTrace
```

## 二、设备连接相关调试信息

### 2.1 设备加载
```
[设备加载] 开始从数据库加载设备列表...
[设备加载] 从数据库加载到 X 个设备
[设备加载] 设备列表: Device1(IP1), Device2(IP2), ...
[设备加载] 开始连接设备 - 名称: DeviceName, IP: DeviceIP, ID: DeviceId
[设备加载] 设备连接成功 - DeviceName(DeviceIP)
[设备加载] 设备连接失败 - DeviceName(DeviceIP)
[设备加载] 设备加载完成 - 成功: X, 失败: Y, 跳过: Z, 总耗时: XXXms
```

### 2.2 设备连接
```
[连接] 开始连接PLC - IP: 192.168.0.1, Rack: 0, Slot: 1
[连接] PLC配置信息 - DataBlock: 1, CollectInterval: 5秒
[连接成功] PLC连接成功 - IP: 192.168.0.1, 耗时: XXXms
[连接成功] 连接状态验证 - IsConnected: True
[连接失败] PLC连接失败 - IP: 192.168.0.1, 错误码: ErrorCode, 耗时: XXXms
[连接失败] 连接状态 - IsConnected: False, ErrorCode: ErrorCode
[连接异常] 连接PLC时发生异常 - IP: 192.168.0.1, 耗时: XXXms
[连接异常] 异常详情 - 类型: ExceptionType, 消息: ExceptionMessage
```

### 2.3 设备重连
```
[状态监控] 设备状态监控任务启动
[状态监控] 监控配置 - 重连间隔: 180秒, 检查间隔: 30秒
[状态监控] 第 X 次状态检查 - 总设备: Y, 在线: Z, 离线: W
[状态监控] 检查设备 - DeviceName(DeviceIP), 距上次尝试: XXX秒, 离线时长: YYY秒, 重连次数: Z
[状态监控] 尝试重连离线设备: DeviceName(DeviceIP)，第 X 次尝试，离线时长: XXX秒
[设备重连] 开始重连设备 - DeviceName(DeviceIP), 重连次数: X
[设备重连] 断开旧连接...
[设备重连] 旧连接已断开
[设备重连] 等待2秒后重新连接...
[设备重连] PLC配置 - IP: DeviceIP, Rack: 0, Slot: 1, DB: 1
[设备重连] 尝试建立新连接...
[设备重连成功] 设备 DeviceName(DeviceIP) 重连成功 - 耗时: XXXms, 重连次数: X
[设备重连成功] 连接状态 - IsConnected: True, DeviceId: DeviceId
[设备重连失败] 设备 DeviceName(DeviceIP) 重连失败 - 耗时: XXXms, 将在 180 秒后重试
[设备重连失败] 连接状态 - IsConnected: False, 下次重连时间: YYYY-MM-DD HH:mm:ss
[设备重连异常] 重连设备 DeviceName(DeviceIP) 时出错 - 耗时: XXXms
[设备重连异常] 异常详情 - 设备ID: DeviceId, 异常类型: ExceptionType, 消息: ExceptionMessage, 堆栈: StackTrace
```

## 三、数据采集相关调试信息

### 3.1 数据采集循环
```
[采集循环] 开始第 X 次数据采集...
[数据采集] 开始采集数据 - 总设备数: X, 在线设备数: Y
[数据采集] 开始采集设备数据 - DeviceName(DeviceIP)
[数据采集成功] 设备 DeviceName(DeviceIP) - 耗时: XXXms, 数据时间: YYYY-MM-DD HH:mm:ss.fff, 新数据/更新数据
[数据采集失败] 设备 DeviceName(DeviceIP) 采集失败 - 耗时: XXXms, IsConnected: False
[数据采集] 跳过离线设备 - DeviceName(DeviceIP), 原因: 连接服务为空/未连接
[数据采集] 数据采集循环完成 - 成功: X, 失败: Y, 跳过: Z, 总耗时: XXXms
[采集循环] 第 X 次数据采集完成 - 耗时: XXXms, 已采集设备数: Y
[采集循环] 等待 5 秒后进行下次采集...
```

### 3.2 数据读取
```
[数据读取] 开始读取数据 - DeviceId: DeviceId, IP: DeviceIP, 时间: YYYY-MM-DD HH:mm:ss.fff
[数据读取] PLC连接信息 - DB编号: 1, 连接状态: True
[数据读取] 开始读取11个工单数据...
```

### 3.3 工单数据读取
```
[工单0] 开始读取工单数据 - 偏移量: 0
[工单0] 读取Workers_Name数组 (11个String, 每个256字节)...
[工单0] Workers_Name[0] = 'WorkerName' (偏移量: 0)
[工单0] 读取SmartBand_No数组 (11个Int, 每个2字节)...
[工单0] SmartBand_No[0] = 12345 (偏移量: 2818)
[工单0] Construction_Order_No = 1001 (偏移量: 2816)
[工单0] Construction_Order_Content = 'OrderContent' (偏移量: 2840)
[工单0] 读取Workers_Status数组 (11个Int, 每个2字节)...
[工单0] Workers_Status[0] = 3 (0=未进入,1=申请进入,2=刷卡成功,3=进入,4=申请签出,5=已签出) (偏移量: 3096)
[工单0] Construction_Status = 1 (0=未开始,1=工单开始,2=工单结束) (偏移量: 3118)
[工单0] 读取Button_In数组 (11个Bool, 位打包)...
[工单0] Button_In字节数据: [FF] [07] (偏移量: 3120)
[工单0] Button_In[0] = true (位0)
[工单0] 读取Button_Out数组 (11个Bool, 位打包)...
[工单0] Button_Out字节数据: [00] [00] (偏移量: 3122)
[工单0] 读取Maximum_HeartRate数组 (11个Int, 每个2字节)...
[工单0] Maximum_HeartRate[0] = 120 (偏移量: 3124)
[工单0] 读取MInimum_HeartRate数组 (11个Int, 每个2字节)...
[工单0] MInimum_HeartRate[0] = 60 (偏移量: 3146)
[工单0] 读取Heart_Rate数组 (11个Int, 每个2字节)...
[工单0] Heart_Rate[0] = 75 (偏移量: 3168)
[工单0] 工单数据读取完成 - 耗时: XXXms
```

### 3.4 全局控制按钮读取
```
[全局控制] 读取全局控制按钮...
[全局控制] ConstructionOrder_Start_PB = True (偏移量: 35090, 位0)
[全局控制] ConstructionOrder_Stop_PB = False (偏移量: 35090, 位1)
```

### 3.5 空工单读取
```
[空工单] 开始读取空工单数据 (Construction_Order_Null)...
```

### 3.6 传感器数据读取
```
[传感器] 开始读取传感器数据...
[传感器] Hazardous_Gas_Alarm_Online = True (偏移量: 38282, 位0)
[传感器] GPS_online = True (偏移量: 38282, 位1)
[传感器] 读取Gas_Alarm数组 (11个Real, 每个4字节)...
[传感器] Gas_Alarm[0] = 12.34 (偏移量: 38284)
[传感器] GPS_lon = 116.123456 (偏移量: 38328)
[传感器] GPS_lat = 39.123456 (偏移量: 38332)
```

### 3.7 数据读取完成
```
[数据读取成功] 成功读取S7数据 - DeviceId: DeviceId, IP: DeviceIP, 总耗时: XXXms
[数据读取成功] 数据统计 - 工单数: 11, 空工单: 1, 传感器数据: Gas(X个非零), GPS: (XXX, YYY)
```

### 3.8 数据读取异常
```
[数据读取异常] 读取S7数据时发生异常 - DeviceId: DeviceId, 耗时: XXXms
[数据读取异常] 异常详情 - 类型: ExceptionType, 消息: ExceptionMessage, 堆栈: StackTrace
```

## 四、底层数据读取调试信息

### 4.1 字节数组读取
```
[字节读取] 读取字节数组 - DB1.DBB3120, 长度: 2
[字节读取] 读取成功 - DB1.DBB3120, 实际长度: 2, 数据: [FF 07]
[字节读取] 读取结果为空 - DB1.DBB3120, 长度: 2
[字节读取异常] 读取字节数组时发生异常 - DB1.DBB3120, 长度: 2
[字节读取异常] 异常详情 - 类型: ExceptionType, 消息: ExceptionMessage
```

### 4.2 Int值读取
```
[Int读取] 读取Int值 - DB1.DBW2816
[Int读取] 读取成功 - DB1.DBW2816, 值: 1001, 原始字节: [03 E9]
[Int读取] 读取失败 - DB1.DBW2816, 字节长度: 0
[Int读取异常] 读取Int值时发生异常 - DB1.DBW2816
[Int读取异常] 异常详情 - 类型: ExceptionType, 消息: ExceptionMessage
```

### 4.3 Real值读取
```
[Real读取] 读取Real值 - DB1.DBD38328
[Real读取] 读取成功 - DB1.DBD38328, 值: 116.123456, 原始字节: [42 E8 00 00]
[Real读取] 读取失败 - DB1.DBD38328, 字节长度: 0
[Real读取异常] 读取Real值时发生异常 - DB1.DBD38328
[Real读取异常] 异常详情 - 类型: ExceptionType, 消息: ExceptionMessage
```

### 4.4 Bool值读取
```
[Bool读取] 读取Bool值 - DB1.DBX35090.0
[Bool读取] 读取成功 - DB1.DBX35090.0, 值: True, 原始字节: [01] (位0)
[Bool读取] 读取失败 - DB1.DBX35090.0, 字节长度: 0
[Bool读取异常] 读取Bool值时发生异常 - DB1.DBX35090.0
[Bool读取异常] 异常详情 - 类型: ExceptionType, 消息: ExceptionMessage
```

### 4.5 String值读取
```
[String读取] 读取字符串 - DB1.DBD0, 长度: 256
[String读取] 读取成功(GBK) - DB1.DBD0, 值: 'WorkerName', 原始长度: 256, 有效长度: 20
[String读取] GBK编码解析失败，使用ASCII编码 - DB1.DBD0
[String读取] 读取成功(ASCII) - DB1.DBD0, 值: 'WorkerName'
[String读取] 读取失败 - DB1.DBD0, 字节长度: 0
[String读取异常] 读取字符串时发生异常 - DB1.DBD0, 长度: 256
[String读取异常] 异常详情 - 类型: ExceptionType, 消息: ExceptionMessage
```

## 五、警告信息

### 5.1 连接警告
```
[连接失败] PLC连接失败 - IP: DeviceIP, 错误码: ErrorCode, 耗时: XXXms
[设备连接失败] 设备 DeviceName(DeviceIP) 连接失败，将定期尝试重连 - 耗时: XXXms
[数据采集] 设备 DeviceName(DeviceIP) 连接已断开
[设备重连失败] 设备 DeviceName(DeviceIP) 重连失败 - 耗时: XXXms, 将在 180 秒后重试
```

### 5.2 数据读取警告
```
[数据读取] PLC未连接，无法读取数据 - DeviceId: DeviceId, IP: DeviceIP
[数据读取] 连接状态检查 - IsConnected: False
[工单X] Button_In数组读取失败 - 字节数据为空或长度不足
[工单X] Button_Out数组读取失败 - 字节数据为空或长度不足
[设备加载] 设备 DeviceName IP地址为空，跳过
```

## 六、错误信息

### 6.1 连接错误
```
[连接异常] 连接PLC时发生异常 - IP: DeviceIP, 耗时: XXXms
[连接异常] 异常详情 - 类型: ExceptionType, 消息: ExceptionMessage
[设备连接异常] 连接设备 DeviceName(DeviceIP) 时出错 - 耗时: XXXms
[设备连接异常] 异常详情 - 设备ID: DeviceId, 异常类型: ExceptionType, 消息: ExceptionMessage, 堆栈: StackTrace
```

### 6.2 数据采集错误
```
[数据采集异常] 采集设备 DeviceName(DeviceIP) 数据时出错 - 耗时: XXXms
[数据采集异常] 异常详情 - 设备ID: DeviceId, 异常类型: ExceptionType, 消息: ExceptionMessage
[数据读取异常] 读取S7数据时发生异常 - DeviceId: DeviceId, 耗时: XXXms
[数据读取异常] 异常详情 - 类型: ExceptionType, 消息: ExceptionMessage, 堆栈: StackTrace
```

### 6.3 底层读取错误
```
[字节读取异常] 读取字节数组时发生异常 - DB1.DBB3120, 长度: 2
[Int读取异常] 读取Int值时发生异常 - DB1.DBW2816
[Real读取异常] 读取Real值时发生异常 - DB1.DBD38328
[Bool读取异常] 读取Bool值时发生异常 - DB1.DBX35090.0
[String读取异常] 读取字符串时发生异常 - DB1.DBD0, 长度: 256
```

## 七、调试信息使用建议

### 7.1 日志级别配置
- **生产环境**: Information, Warning, Error
- **开发环境**: Information, Warning, Error, Debug
- **问题排查**: Information, Warning, Error, Debug, Trace

### 7.2 常见问题排查

#### 连接问题
1. 查看 `[连接]` 和 `[连接失败]` 日志
2. 检查IP地址、Rack、Slot配置
3. 查看网络连接状态

#### 数据读取问题
1. 查看 `[数据读取]` 和 `[数据读取异常]` 日志
2. 检查DB编号和偏移量是否正确
3. 查看 `[字节读取]`、`[Int读取]` 等底层日志

#### 性能问题
1. 查看 `[数据采集]` 日志中的耗时信息
2. 检查采集间隔配置
3. 查看设备连接状态

### 7.3 日志过滤
可以使用日志过滤功能，按标签过滤：
- `[服务启动]` - 服务启动相关
- `[设备连接]` - 设备连接相关
- `[数据采集]` - 数据采集相关
- `[工单X]` - 特定工单数据
- `[传感器]` - 传感器数据
- `[异常]` - 所有异常信息

## 八、日志示例

### 8.1 正常启动流程
```
[服务启动] S7 PLC数据采集服务启动
[服务启动] 服务配置 - CollectInterval: 5秒, Rack: 0, Slot: 1, DataBlock: 1
[设备加载] 从数据库加载到 3 个设备
[连接] 开始连接PLC - IP: 192.168.0.1, Rack: 0, Slot: 1
[连接成功] PLC连接成功 - IP: 192.168.0.1, 耗时: 125.50ms
[服务启动] 设备连接完成 - 已连接设备数: 3, 总设备数: 3
[服务启动] 开始定时采集数据循环...
[采集循环] 开始第 1 次数据采集...
[数据采集成功] 设备 Device1(192.168.0.1) - 耗时: 234.56ms, 数据时间: 2024-01-01 12:00:00.123, 新数据
```

### 8.2 连接失败流程
```
[连接] 开始连接PLC - IP: 192.168.0.2, Rack: 0, Slot: 1
[连接失败] PLC连接失败 - IP: 192.168.0.2, 错误码: ConnectionError, 耗时: 5000.00ms
[设备连接失败] 设备 Device2(192.168.0.2) 连接失败，将定期尝试重连 - 耗时: 5000.00ms
[状态监控] 第 1 次状态检查 - 总设备: 3, 在线: 2, 离线: 1
[状态监控] 尝试重连离线设备: Device2(192.168.0.2)，第 1 次尝试，离线时长: 180.0秒
[设备重连失败] 设备 Device2(192.168.0.2) 重连失败 - 耗时: 5000.00ms, 将在 180 秒后重试
```

### 8.3 数据读取异常流程
```
[数据采集] 开始采集设备数据 - Device1(192.168.0.1)
[数据读取] 开始读取数据 - DeviceId: device1, IP: 192.168.0.1, 时间: 2024-01-01 12:00:00.123
[工单0] 开始读取工单数据 - 偏移量: 0
[Int读取异常] 读取Int值时发生异常 - DB1.DBW2816
[Int读取异常] 异常详情 - 类型: PlcException, 消息: Connection lost
[数据读取异常] 读取S7数据时发生异常 - DeviceId: device1, 耗时: 45.67ms
[数据采集失败] 设备 Device1(192.168.0.1) 采集失败 - 耗时: 45.67ms, IsConnected: False
```

## 九、注意事项

1. **日志级别**: Trace级别日志会产生大量输出，建议仅在深度调试时启用
2. **性能影响**: 详细的日志记录会影响性能，生产环境建议使用Information级别
3. **日志存储**: 建议配置日志轮转，避免日志文件过大
4. **敏感信息**: 日志中可能包含设备IP等敏感信息，注意日志安全


