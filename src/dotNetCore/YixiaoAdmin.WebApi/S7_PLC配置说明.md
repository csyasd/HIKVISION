# S7 PLC数据采集系统 - 配置说明

## 一、配置概述

S7 PLC数据采集系统采用**客户端-服务器**架构：
- **PLC（西门子S7）**: 服务器端（Server），被动等待连接
- **上位机（本系统）**: 客户端（Client），主动连接PLC

**重要说明**：**不需要在PLC中配置上位机的IP地址**，只需要在系统中配置PLC的IP地址即可。

## 二、配置步骤

### 2.1 数据库配置（必需）

在 `Device` 表中添加或更新设备记录，**必须填写IP地址字段**：

```sql
-- 示例：更新设备IP地址
UPDATE Device SET IP = '192.168.0.100' WHERE Id = '设备ID';

-- 或者插入新设备
INSERT INTO Device (Id, Name, IP, ...) 
VALUES ('设备ID', '设备名称', '192.168.0.100', ...);
```

**字段说明**：
- `IP`: PLC的IP地址（必需，不能为空）
- `Name`: 设备名称（建议填写，便于识别）
- `Id`: 设备唯一标识

### 2.2 应用程序配置（appsettings.json）

在 `appsettings.json` 中配置PLC连接参数：

```json
{
  "S7Plc": {
    "Rack": 0,              // 机架号（默认0）
    "Slot": 1,              // 槽位号（默认1，S7-1200/1500通常为1）
    "DataBlockNumber": 1,   // 数据块编号（DB1）
    "CollectInterval": 5,   // 采集间隔（秒）
    "ReconnectInterval": 180 // 重连间隔（秒）
  }
}
```

**参数说明**：

| 参数 | 说明 | 默认值 | 备注 |
|------|------|--------|------|
| Rack | 机架号 | 0 | S7-1200/1500通常为0 |
| Slot | 槽位号 | 1 | S7-1200通常为1，S7-1500根据实际配置 |
| DataBlockNumber | 数据块编号 | 1 | 对应PLC中的DB1 |
| CollectInterval | 采集间隔（秒） | 5 | 数据采集频率 |
| ReconnectInterval | 重连间隔（秒） | 180 | 离线设备重连间隔 |

### 2.3 PLC端配置（可选，但建议检查）

虽然不需要在PLC中配置上位机IP，但需要确保以下设置：

#### 2.3.1 网络配置
- ✅ PLC的IP地址已正确配置
- ✅ PLC与上位机在同一网段或网络可达
- ✅ 防火墙允许S7通信端口（默认102端口）

#### 2.3.2 安全设置（如果PLC启用了安全功能）
某些PLC可能启用了IP白名单或访问控制，需要：
- 检查PLC的"连接资源"设置
- 确保允许外部客户端连接
- 如果启用了IP白名单，需要添加上位机的IP地址

#### 2.3.3 数据块配置
- ✅ 确保DB1数据块存在
- ✅ 数据块大小足够（至少38336字节，根据偏移量表）
- ✅ 数据块属性设置为"非优化访问"（如果使用S7-1500）

## 三、配置检查清单

### ✅ 必需配置项

- [ ] Device表中设备记录已添加IP地址
- [ ] appsettings.json中S7Plc配置已设置
- [ ] PLC IP地址正确
- [ ] 上位机与PLC网络连通（可以ping通）

### ✅ 推荐检查项

- [ ] PLC防火墙设置允许S7通信
- [ ] PLC连接资源充足（允许外部连接）
- [ ] DB1数据块已创建且大小足够
- [ ] 数据块偏移量配置正确

## 四、快速开始

### 步骤1：添加设备IP地址

在设备管理界面或数据库中，为每个PLC设备添加IP地址：

```
设备名称: PLC设备1
IP地址: 192.168.0.100
```

### 步骤2：检查appsettings.json配置

确认以下配置正确：

```json
{
  "S7Plc": {
    "Rack": 0,
    "Slot": 1,
    "DataBlockNumber": 1,
    "CollectInterval": 5,
    "ReconnectInterval": 180
  }
}
```

### 步骤3：启动服务

启动应用程序，系统会自动：
1. 从数据库加载所有设备
2. 尝试连接每个有IP地址的设备
3. 开始定时采集数据

### 步骤4：查看日志

查看日志确认连接状态：

```
[设备加载] 从数据库加载到 X 个设备
[连接成功] PLC连接成功 - IP: 192.168.0.100, 耗时: XXXms
[数据采集成功] 设备 PLC设备1(192.168.0.100) - 耗时: XXXms
```

## 五、常见问题

### Q1: 是否需要在PLC中配置上位机的IP地址？

**A**: **不需要**。S7 PLC通信是客户端主动连接服务器，PLC作为服务器被动等待连接，所以不需要在PLC中配置上位机IP。

**但是**，如果PLC启用了安全功能（如IP白名单），可能需要在上位机IP白名单中添加上位机的IP地址。

### Q2: 连接失败怎么办？

**检查清单**：
1. ✅ 确认Device表中IP地址已填写且正确
2. ✅ 确认PLC与上位机网络连通（ping测试）
3. ✅ 确认appsettings.json中Rack和Slot配置正确
4. ✅ 确认PLC防火墙允许S7通信（端口102）
5. ✅ 查看日志中的错误信息

### Q3: 如何确认PLC的Rack和Slot？

- **S7-1200**: Rack=0, Slot=1（固定）
- **S7-1500**: Rack=0, Slot根据实际硬件配置（通常为1）
- **S7-300/400**: 根据实际硬件配置

可以通过TIA Portal查看硬件配置确认。

### Q4: 数据读取失败怎么办？

**检查清单**：
1. ✅ 确认DB1数据块存在
2. ✅ 确认数据块大小足够（至少38336字节）
3. ✅ 确认数据块属性（S7-1500需要设置为"非优化访问"）
4. ✅ 查看日志中的详细错误信息

### Q5: 如何测试连接？

可以使用以下方法测试：
1. **Ping测试**: `ping 192.168.0.100`
2. **查看日志**: 启动服务后查看连接日志
3. **API测试**: 调用 `/api/S7DataCollection/status` 查看连接状态

## 六、网络架构图

```
┌─────────────────┐         S7通信协议         ┌──────────────┐
│                 │    (TCP/IP, 端口102)      │              │
│   上位机系统     │ ────────────────────────> │   S7 PLC     │
│  (客户端)        │                           │  (服务器)    │
│                 │ <──────────────────────── │              │
│  IP: 192.168.0.10│                           │ IP: 192.168.0.100│
└─────────────────┘                           └──────────────┘
        │                                              │
        └──────────────────────────────────────────────┘
                   同一网段或网络可达
```

**通信流程**：
1. 上位机主动发起连接请求（使用PLC的IP地址）
2. PLC接受连接请求
3. 建立TCP连接（端口102）
4. 上位机读取数据
5. 上位机断开连接

## 七、配置示例

### 示例1：单设备配置

**数据库（Device表）**：
```
Id: device001
Name: 生产车间PLC1
IP: 192.168.0.100
```

**appsettings.json**：
```json
{
  "S7Plc": {
    "Rack": 0,
    "Slot": 1,
    "DataBlockNumber": 1,
    "CollectInterval": 5,
    "ReconnectInterval": 180
  }
}
```

### 示例2：多设备配置

**数据库（Device表）**：
```
设备1:
  Id: device001
  Name: 生产车间PLC1
  IP: 192.168.0.100

设备2:
  Id: device002
  Name: 生产车间PLC2
  IP: 192.168.0.101

设备3:
  Id: device003
  Name: 仓库PLC
  IP: 192.168.0.102
```

系统会自动连接所有配置了IP地址的设备。

## 八、注意事项

1. **IP地址格式**: 确保IP地址格式正确（如：192.168.0.100）
2. **网络连通性**: 确保上位机与PLC在同一网段或路由可达
3. **防火墙**: 确保防火墙允许S7通信（端口102）
4. **PLC资源**: 确保PLC有足够的连接资源
5. **数据块大小**: 确保DB1数据块大小足够（至少38336字节）
6. **采集频率**: 根据实际需求调整采集间隔，避免过于频繁

## 九、总结

**最简单的配置方式**：
1. ✅ 在Device表中添加PLC的IP地址
2. ✅ 确认appsettings.json配置正确
3. ✅ 启动服务

**不需要**：
- ❌ 在PLC中配置上位机IP（除非启用了IP白名单）
- ❌ 修改PLC程序（除非数据块配置不正确）
- ❌ 复杂的网络配置（只要网络可达即可）

系统会自动处理连接、重连和数据采集。

